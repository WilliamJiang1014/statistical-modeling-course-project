# 建模技术说明文档

## 一、模型概述

### 1.1 回归模型（住院天数预测）
- **模型类型**：多元线性回归
- **因变量**：`time_in_hospital`（住院天数，连续变量）
- **评估指标**：R²、调整R²、RMSE、MAE
- **模型诊断**：残差分析、多重共线性检查（VIF）

### 1.2 分类模型（30天再入院预测）
- **模型类型**：Logistic回归
- **因变量**：`readmitted_30d`（0/1二分类）
- **评估指标**：准确率、精确率、召回率、F1值、AUC
- **类别不平衡处理**：使用类别权重（class_weight='balanced'）

---

## 二、特征工程

### 2.1 诊断编码分组（ICD-9）
将ICD-9诊断编码分组为以下类别：
- **Diabetes**：糖尿病相关（250-250.99）
- **Circulatory**：心血管相关（390-459, 785-785.99）
- **Respiratory**：呼吸系统相关（460-519）
- **Digestive**：消化系统相关（520-579）
- **Genitourinary**：泌尿生殖系统相关（580-629）
- **Injury**：损伤相关（800-999）
- **Neoplasms**：肿瘤相关（140-239）
- **Other**：其他疾病
- **Unknown**：未知或缺失

### 2.2 出院去向分组
将30个出院去向类别分组为：
- **Home**：回家
- **Transfer**：转院/转机构
- **Other_Facility**：其他医疗机构
- **Other**：其他
- **Death_Other**：死亡/其他

### 2.3 入院来源分组
将25个入院来源类别分组为：
- **Referral**：转诊（医生/诊所/HMO转诊）
- **Transfer**：转院
- **Emergency_Other**：急诊/其他
- **Other**：其他

### 2.4 特征编码
- **分类变量**：使用R的`factor()`和`as.numeric()`进行标签编码
- **连续变量**：使用`caret::preProcess()`进行标准化（center和scale）

---

## 三、模型构建流程

### 3.1 数据准备
1. 运行 `code/06_feature_engineering.R` 进行特征工程和数据分割
2. 生成训练集和测试集（80/20分割，使用`caret::createDataPartition()`）
3. 保存数据分割结果到 `data/processed/data_splits.rds`（R格式）

### 3.2 回归模型构建
1. 运行 `code/07_regression_model.R`
2. 构建基准模型（使用基准特征集，R的`lm()`函数）
3. 构建改进模型（使用增强特征集）
4. 进行模型诊断（残差分析、VIF检查，使用`car::vif()`）
5. 生成可视化图表（使用`ggplot2`）
6. 保存模型到 `models/regression_model.rds`（R格式）

### 3.3 分类模型构建
1. 运行 `code/08_classification_model.R`
2. 计算类别权重处理不平衡问题（使用`table()`计算权重）
3. 构建基准模型和改进模型（使用R的`glm(family=binomial)`）
4. 计算OR值（优势比，`exp(coef(model))`）
5. 生成可视化图表（ROC曲线使用`pROC::roc()`，混淆矩阵使用`caret::confusionMatrix()`）
6. 保存模型到 `models/classification_model.rds`（R格式）

---

## 四、模型评估结果

### 4.1 回归模型评估指标
- **R²（决定系数）**：衡量模型解释的方差比例
- **RMSE（均方根误差）**：预测误差的标准差
- **MAE（平均绝对误差）**：预测误差的平均值

### 4.2 分类模型评估指标
- **准确率（Accuracy）**：正确预测的比例
- **精确率（Precision）**：预测为正例中真正为正例的比例
- **召回率（Recall）**：真正例中被正确预测的比例
- **F1值**：精确率和召回率的调和平均
- **AUC**：ROC曲线下面积，衡量分类器区分能力

### 4.3 OR值（优势比）解读
- **OR > 1**：该因素增加再入院风险
- **OR < 1**：该因素降低再入院风险
- **OR = 1**：该因素对再入院风险无影响

---

## 五、模型诊断

### 5.1 回归模型诊断
1. **残差分析**：
   - 残差vs预测值散点图（检查异方差）
   - Q-Q图（检查正态性）
   - 残差分布直方图

2. **多重共线性检查**：
   - 计算VIF（方差膨胀因子）
   - VIF > 10 表示存在多重共线性问题

### 5.2 分类模型诊断
1. **混淆矩阵**：展示预测结果与实际结果的对比
2. **ROC曲线**：展示不同阈值下的真阳性率和假阳性率
3. **预测概率分布**：展示模型对正负样本的区分能力

---

## 六、系统使用说明

### 6.1 运行环境

**R环境配置**：
在R或RStudio中运行：
```r
source("install_packages.R")
```

主要R包：
- `dplyr`, `tidyr`, `readr` - 数据处理
- `caret` - 数据分割和模型评估
- `car` - VIF检查
- `pROC` - ROC曲线
- `ggplot2`, `gridExtra` - 可视化
- `shiny`, `shinydashboard`, `DT` - Web应用

### 6.2 运行步骤

在R或RStudio中运行：

1. **特征工程**：
   ```r
   source("code/06_feature_engineering.R")
   ```

2. **回归模型**：
   ```r
   source("code/07_regression_model.R")
   ```

3. **分类模型**：
   ```r
   source("code/08_classification_model.R")
   ```

4. **启动系统**：
   ```r
   shiny::runApp("code/09_shiny_app")
   ```

### 6.3 系统功能
- **数据概览**：展示数据基本信息和EDA图表
- **预处理展示**：展示数据清洗和特征工程过程
- **模型结果**：展示模型评估指标和可视化图表
- **风险预测**：交互式输入患者特征，预测再入院风险和住院天数

---

## 七、模型解读要点

### 7.1 回归模型系数解读
- **正系数**：该变量增加时，住院天数增加
- **负系数**：该变量增加时，住院天数减少
- **系数大小**：反映影响程度（需考虑变量标准化）

### 7.2 分类模型OR值解读
- **OR值**：表示该因素存在时，再入院风险是基准的多少倍
- **置信区间**：OR值的95%置信区间，不包含1表示有统计学意义

### 7.3 关键影响因素
根据模型结果，以下因素通常与再入院风险和住院天数相关：
- **诊断数量**：诊断数量越多，风险越高
- **既往就医史**：既往住院/急诊次数多，风险高
- **年龄**：老年患者风险更高
- **用药情况**：使用胰岛素的患者可能需要更长住院时间

---

## 八、注意事项

1. **数据不平衡**：30天再入院率仅11.16%，使用类别权重处理
2. **多重共线性**：某些变量间存在相关性，需检查VIF
3. **因果推断**：注意区分预测变量和结果变量（如住院天数在预测再入院时需谨慎使用）
4. **模型泛化**：模型在测试集上的表现可能略低于训练集，这是正常的

---

## 九、文件结构

```
code/
├── 06_feature_engineering.R     # 特征工程（R语言）
├── 07_regression_model.R        # 回归模型（R语言）
├── 08_classification_model.R    # 分类模型（R语言）
└── 09_shiny_app/                # Shiny原型系统（R语言）
    └── app.R                    # Shiny应用主文件

models/
├── regression_model.rds         # 回归模型文件（R格式）
└── classification_model.rds     # 分类模型文件（R格式）

data/processed/
└── data_splits.rds              # 数据分割结果（R格式）

docs/figures/
├── 07_regression_coefficients.png
├── 08_regression_diagnostics.png
├── 09_classification_or_values.png
├── 10_classification_confusion_matrix.png
├── 11_classification_roc_curve.png
└── 12_classification_probability_distribution.png
```


